import streamlit as st
import requests
import pandas as pd
from ta.momentum import RSIIndicator

# Lexo API Key nga secrets
API_KEY = st.secrets["COINGECKO_API_KEY"]

# Funksion pÃ«r tÃ« marrÃ« tÃ« dhÃ«nat e tregut pÃ«r njÃ« kriptomonedhÃ«
def get_coin_data(coin_id):
    url = "https://api.coingecko.com/api/v3/coins/" + coin_id + "/market_chart"
    headers = {
        "accept": "application/json",
        "x-cg-api-key": API_KEY
    }
    params = {
        "vs_currency": "usd",
        "days": "7",
        "interval": "hourly"
    }
    response = requests.get(url, headers=headers, params=params)
    if response.status_code == 200:
        data = response.json()
        prices = data["prices"]
        df = pd.DataFrame(prices, columns=["timestamp", "price"])
        df["timestamp"] = pd.to_datetime(df["timestamp"], unit='ms')
        df.set_index("timestamp", inplace=True)
        return df
    else:
        st.error("Gabim: " + str(response.status_code))
        return None

# Shfaq tÃ« dhÃ«nat dhe RSI pÃ«r njÃ« monedhÃ«
def show_dashboard(coin_id, coin_name):
    st.title(f"{coin_name} ğŸ“Š Dashboard")
    df = get_coin_data(coin_id)
    if df is not None:
        st.line_chart(df["price"], height=300)
        rsi = RSIIndicator(close=df["price"]).rsi()
        st.line_chart(rsi, height=200)
        latest_price = df["price"].iloc[-1]
        st.metric(label="ğŸ’° Ã‡mimi i fundit (USD)", value=f"${latest_price:,.2f}")

# Zgjedhje nga pÃ«rdoruesi
coin_map = {
    "Bitcoin": "bitcoin",
    "Ethereum": "ethereum",
    "XRP": "ripple"
}
coin_name = st.selectbox("Zgjidh kriptomonedhÃ«n", list(coin_map.keys()))
show_dashboard(coin_map[coin_name], coin_name)
